<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Drag and Drop Agent View</title>
    <style>
        .test-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
        }
        .agent-column {
            display: inline-block;
            width: 200px;
            min-height: 150px;
            margin: 10px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            vertical-align: top;
        }
        .column-header {
            padding: 10px;
            background: #eee;
            font-weight: bold;
        }
        .ticket-list {
            padding: 5px;
            min-height: 100px;
        }
        .ticket-item {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            background: white;
            cursor: move;
        }
        .ticket-item.dragging {
            opacity: 0.5;
        }
        .ticket-list.drag-over {
            background: #e0ffe0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .success { background: #e0ffe0; }
        .error { background: #ffe0e0; }
    </style>
</head>
<body>
    <h1>Test Drag and Drop Agent View</h1>
    <div id="test-results"></div>
    
    <div class="test-container">
        <h2>Mock Agent Columns</h2>
        <div class="agent-column">
            <div class="column-header">John Doe</div>
            <div class="ticket-list" id="agent-123" data-agent-id="123">
                <div class="ticket-item" draggable="true" data-ticket-id="1001" data-user-id="123">
                    Ticket #1001 - John's Ticket
                </div>
            </div>
        </div>
        
        <div class="agent-column">
            <div class="column-header">Jane Smith</div>
            <div class="ticket-list" id="agent-456" data-agent-id="456">
                <!-- Empty initially -->
            </div>
        </div>
        
        <div class="agent-column">
            <div class="column-header">Unassigned</div>
            <div class="ticket-list" id="agent-unassigned" data-agent-id="unassigned">
                <div class="ticket-item" draggable="true" data-ticket-id="1002" data-user-id="">
                    Ticket #1002 - Unassigned Ticket
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Mock drag and drop functionality based on dashboard.js implementation
        class MockDragDropTest {
            constructor() {
                this.draggedTicket = null;
                this.testResults = [];
                this.setupMockDragAndDrop();
            }

            setupMockDragAndDrop() {
                // Add drag event listeners to tickets
                const tickets = document.querySelectorAll('.ticket-item');
                tickets.forEach(ticket => {
                    ticket.addEventListener('dragstart', (event) => {
                        this.draggedTicket = ticket;
                        ticket.classList.add('dragging');
                        event.dataTransfer.setData('text/plain', ticket.getAttribute('data-ticket-id'));
                        event.dataTransfer.effectAllowed = 'move';
                        this.logTest(`Started dragging ticket #${ticket.getAttribute('data-ticket-id')}`);
                    });

                    ticket.addEventListener('dragend', () => {
                        ticket.classList.remove('dragging');
                        this.draggedTicket = null;
                        this.logTest(`Stopped dragging ticket #${ticket.getAttribute('data-ticket-id')}`);
                    });
                });

                // Add drop zone listeners to agent columns
                const agentColumns = document.querySelectorAll('.ticket-list');
                agentColumns.forEach(column => {
                    this.setupAgentDropZone(column);
                });
            }

            setupAgentDropZone(container) {
                const agentId = container.getAttribute('data-agent-id');
                
                container.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    container.classList.add('drag-over');
                });

                container.addEventListener('dragleave', () => {
                    container.classList.remove('drag-over');
                });

                container.addEventListener('drop', (event) => {
                    event.preventDefault();
                    container.classList.remove('drag-over');

                    if (!this.draggedTicket) return;

                    const ticketId = this.draggedTicket.getAttribute('data-ticket-id');
                    const currentOwnerId = this.draggedTicket.getAttribute('data-user-id');
                    
                    // Convert agentId for comparison
                    const targetAgentId = agentId === 'unassigned' ? null : agentId;
                    const currentAgentId = currentOwnerId === 'null' || !currentOwnerId ? null : currentOwnerId;

                    // Check if dropped on same agent
                    if (currentAgentId == targetAgentId) {
                        this.logTest(`âœ… Correctly detected same agent drop for ticket #${ticketId}`, 'success');
                        return;
                    }

                    this.logTest(`ðŸ”„ Ticket #${ticketId} dropped on different agent: ${agentId}`, 'success');
                    
                    // Simulate successful drop by moving the element
                    container.appendChild(this.draggedTicket);
                    this.draggedTicket.setAttribute('data-user-id', targetAgentId || '');
                    
                    // Update ticket display
                    const agentName = agentId === 'unassigned' ? 'Unassigned' : 
                                     agentId === '123' ? 'John Doe' : 
                                     agentId === '456' ? 'Jane Smith' : `Agent ${agentId}`;
                    
                    this.logTest(`âœ… Successfully moved ticket #${ticketId} to ${agentName}`, 'success');
                });
            }

            logTest(message, type = 'info') {
                this.testResults.push({ message, type, timestamp: new Date().toLocaleTimeString() });
                this.updateTestDisplay();
            }

            updateTestDisplay() {
                const resultsContainer = document.getElementById('test-results');
                resultsContainer.innerHTML = '<h2>Test Results</h2>';
                
                this.testResults.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-result ${result.type}`;
                    div.innerHTML = `<strong>[${result.timestamp}]</strong> ${result.message}`;
                    resultsContainer.appendChild(div);
                });
            }

            runAutomatedTests() {
                this.logTest('ðŸ§ª Starting automated drag and drop tests...', 'info');
                
                // Test 1: Verify drag setup
                const draggableTickets = document.querySelectorAll('.ticket-item[draggable="true"]');
                this.logTest(`âœ… Found ${draggableTickets.length} draggable tickets`, 'success');
                
                // Test 2: Verify drop zones
                const dropZones = document.querySelectorAll('.ticket-list[data-agent-id]');
                this.logTest(`âœ… Found ${dropZones.length} agent drop zones`, 'success');
                
                // Test 3: Verify event listeners are attached
                const hasEventListeners = Array.from(draggableTickets).every(ticket => {
                    const events = getEventListeners ? getEventListeners(ticket) : null;
                    return events && (events.dragstart || true); // Fallback to true if getEventListeners not available
                });
                this.logTest(`âœ… Drag event listeners appear to be attached`, 'success');
                
                this.logTest('ðŸŽ¯ Manual test: Try dragging tickets between agent columns above!', 'info');
            }
        }

        // Initialize test when page loads
        window.onload = () => {
            const test = new MockDragDropTest();
            setTimeout(() => test.runAutomatedTests(), 500);
        };
    </script>
</body>
</html>