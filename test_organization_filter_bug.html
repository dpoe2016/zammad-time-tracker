<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Filter Bug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .bug { background-color: #ffe6e6; }
        .fixed { background-color: #e6ffe6; }
        .code { background-color: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre; }
    </style>
</head>
<body>
    <h1>Organization Filter Bug Test</h1>
    
    <div class="test-section bug">
        <h2>Bug Found: Inconsistent Organization ID Access</h2>
        <p><strong>Issue:</strong> The organization filter doesn't work in agent view because of inconsistent property access.</p>
        
        <h3>Current Code (Buggy):</h3>
        <div class="code">
// In populateOrganizationFilterFromTickets() - Line 1886-1888:
this.tickets.forEach(t => {
    if (t.organization_id) organizationIds.add(String(t.organization_id));
});

// In applyTicketFilters() - Line 932-934:
if (this.selectedOrganization !== 'all') {
    if (!ticket.customer || ticket.customer.organization_id.toString() !== this.selectedOrganization) return false;
}
        </div>
        
        <p><strong>Problem:</strong> The populate function expects <code>ticket.organization_id</code> but the filter function expects <code>ticket.customer.organization_id</code>.</p>
    </div>
    
    <div class="test-section">
        <h2>Test Data Structure</h2>
        <div class="code">
// Sample ticket structure based on Zammad API:
const sampleTickets = [
    {
        id: 1,
        title: "Test Ticket 1",
        organization_id: 5,
        customer: {
            organization_id: 5
        },
        owner_id: 2,
        state_id: 1
    },
    {
        id: 2, 
        title: "Test Ticket 2",
        organization_id: null,
        customer: null,
        owner_id: 3,
        state_id: 2
    }
];
        </div>
    </div>
    
    <div class="test-section fixed">
        <h2>Proposed Fix</h2>
        <p>Update the applyTicketFilters function to check both possible organization_id locations:</p>
        <div class="code">
// Fixed organization filter logic:
if (this.selectedOrganization !== 'all') {
    const orgId = ticket.organization_id || (ticket.customer && ticket.customer.organization_id);
    if (this.selectedOrganization === 'none') {
        // Filter for tickets with no organization
        if (orgId) return false;
    } else {
        // Filter for specific organization
        if (!orgId || orgId.toString() !== this.selectedOrganization) return false;
    }
}
        </div>
    </div>
    
    <script>
        console.log('Organization Filter Bug Test loaded');
        console.log('This test demonstrates the inconsistency in organization_id access patterns');
        
        // Simulate the bug
        const tickets = [
            { id: 1, organization_id: 5, customer: { organization_id: 5 } },
            { id: 2, organization_id: null, customer: null }
        ];
        
        console.log('Sample tickets:', tickets);
        
        // Show how populate function works
        const organizationIds = new Set();
        tickets.forEach(t => {
            if (t.organization_id) organizationIds.add(String(t.organization_id));
        });
        console.log('Organizations found by populate function:', Array.from(organizationIds));
        
        // Show how filter function fails
        const selectedOrganization = '5';
        const buggyFilterResult = tickets.filter(ticket => {
            if (selectedOrganization !== 'all') {
                if (!ticket.customer || ticket.customer.organization_id.toString() !== selectedOrganization) return false;
            }
            return true;
        });
        
        console.log('Buggy filter result (should include ticket 1 but may fail):', buggyFilterResult);
        
        // Show how fixed filter works
        const fixedFilterResult = tickets.filter(ticket => {
            if (selectedOrganization !== 'all') {
                const orgId = ticket.organization_id || (ticket.customer && ticket.customer.organization_id);
                if (selectedOrganization === 'none') {
                    if (orgId) return false;
                } else {
                    if (!orgId || orgId.toString() !== selectedOrganization) return false;
                }
            }
            return true;
        });
        
        console.log('Fixed filter result (should properly include ticket 1):', fixedFilterResult);
    </script>
</body>
</html>