<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Owner Name Display</title>
</head>
<body>
    <h1>Test Owner Name Display</h1>
    <div id="test-results"></div>
    
    <script>
        // Mock dashboard class with the fixed methods
        class MockDashboard {
            constructor() {
                this.userCache = new Map();
                this.users = [
                    { id: 123, firstname: 'John', lastname: 'Doe', login: 'john.doe', email: 'john@example.com' },
                    { id: 456, firstname: 'Jane', lastname: 'Smith', login: 'jane.smith', email: 'jane@example.com' }
                ];
            }

            getUserDisplayName(userId) {
                // Check cache first
                if (this.userCache && this.userCache.has(userId)) {
                    return this.userCache.get(userId);
                }

                // Try to find user in our users array
                const user = this.users.find(u => u.id == userId);
                if (user) {
                    const fullName = `${user.firstname || ''} ${user.lastname || ''}`.trim() || user.login || user.email || `User ${user.id}`;
                    if (this.userCache) {
                        this.userCache.set(userId, fullName);
                    }
                    return fullName;
                }

                // Fallback
                return `User ${userId}`;
            }

            getAgentName(ticket) {
                // Try to get name from various ticket properties
                if (ticket.owner_data && ticket.owner_data.firstname && ticket.owner_data.lastname) {
                    return `${ticket.owner_data.firstname} ${ticket.owner_data.lastname}`;
                }
                if (ticket.owner_data && ticket.owner_data.login) {
                    return ticket.owner_data.login;
                }
                if (ticket.owner_name) {
                    return ticket.owner_name;
                }
                // Use getUserDisplayName for consistent user name resolution
                if (ticket.owner_id) {
                    return this.getUserDisplayName(ticket.owner_id);
                }
                return 'NOT ASSIGNED';
            }
        }

        function testOwnerNameDisplay() {
            const results = document.getElementById('test-results');
            const dashboard = new MockDashboard();

            // Test data
            const testTickets = [
                { id: 1, owner_id: 123, title: 'Ticket with known owner' },
                { id: 2, owner_id: 456, title: 'Ticket with another known owner' },
                { id: 3, owner_id: 999, title: 'Ticket with unknown owner' },
                { id: 4, title: 'Ticket without owner' },
                { id: 5, owner_data: { firstname: 'Bob', lastname: 'Wilson' }, title: 'Ticket with owner_data' },
                { id: 6, owner_name: 'Alice Cooper', title: 'Ticket with owner_name' }
            ];

            results.innerHTML += '<h2>Owner Name Display Tests</h2>';

            testTickets.forEach((ticket, index) => {
                const agentName = dashboard.getAgentName(ticket);
                results.innerHTML += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">`;
                results.innerHTML += `<strong>Test ${index + 1}:</strong> ${ticket.title}<br>`;
                results.innerHTML += `Owner ID: ${ticket.owner_id || 'none'}<br>`;
                results.innerHTML += `Display Name: <strong>${agentName}</strong><br>`;
                
                // Check if it's showing an ID vs name
                const showsId = agentName.includes('User ') && ticket.owner_id;
                const showsActualName = !agentName.includes('User ') && ticket.owner_id;
                const isNotAssigned = agentName === 'NOT ASSIGNED';
                
                if (ticket.owner_id && showsActualName) {
                    results.innerHTML += `<span style="color: green;">✅ PASS - Shows name instead of ID</span>`;
                } else if (!ticket.owner_id && isNotAssigned) {
                    results.innerHTML += `<span style="color: green;">✅ PASS - Properly shows NOT ASSIGNED</span>`;
                } else if (ticket.owner_data || ticket.owner_name) {
                    results.innerHTML += `<span style="color: green;">✅ PASS - Uses provided owner data</span>`;
                } else if (showsId) {
                    results.innerHTML += `<span style="color: orange;">⚠️ FALLBACK - Shows fallback for unknown user</span>`;
                } else {
                    results.innerHTML += `<span style="color: red;">❌ FAIL - Unexpected result</span>`;
                }
                
                results.innerHTML += '</div>';
            });

            // Summary
            results.innerHTML += '<h3>Summary</h3>';
            results.innerHTML += '<p>✅ The getAgentName method now properly displays user names instead of raw owner IDs</p>';
            results.innerHTML += '<p>✅ Unknown users show a fallback "User {ID}" instead of just the ID</p>';
            results.innerHTML += '<p>✅ Unassigned tickets show "NOT ASSIGNED" instead of undefined/null</p>';
        }

        // Run tests when page loads
        window.onload = testOwnerNameDisplay;
    </script>
</body>
</html>