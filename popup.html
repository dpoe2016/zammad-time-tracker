<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zammad Timetracking</title>
    <style>
        body {
            width: 300px;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background: #f8f9fa;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            cursor: pointer;
        }
        
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #007bff;
        }
        
        .status {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #dee2e6;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-dot.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-dot.inactive {
            background: #6c757d;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .ticket-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .timer-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #333;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }
        
        .controls {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .info {
            background: #e9ecef;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        
        .info.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info.success {
            background: #d4edda;
            color: #155724;
        }
        
        .settings {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        
        .settings-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .switch {
            position: relative;
            width: 40px;
            height: 20px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #007bff;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .debug {
            margin-top: 10px;
            padding: 8px;
            background: #fff3cd;
            border-radius: 4px;
            font-size: 11px;
            color: #856404;
            display: none;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>⏱ Zammad Timetracking</h1>
        <div>Zeiterfassung für Tickets</div>
    </div>
    
    <div class="status">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Nicht aktiv</span>
        </div>
        
        <div class="ticket-info" id="ticketInfo" style="display: none;">
            Ticket: <span id="ticketId">-</span>
        </div>
        
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        
        <div class="controls">
            <button class="btn btn-primary" id="startBtn">Start</button>
            <button class="btn btn-danger" id="stopBtn" disabled>Stop</button>
        </div>
    </div>
    
    <div class="info" id="infoText">
        Überprüfe Zammad-Seite...
    </div>
    
    <div class="settings">
        <div class="settings-title">Einstellungen</div>
        
        <div class="setting-item">
            <span>Benachrichtigungen</span>
            <label class="switch">
                <input type="checkbox" id="notificationsToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="setting-item">
            <span>Auto-Submit</span>
            <label class="switch">
                <input type="checkbox" id="autoSubmitToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>
    
    <div class="debug" id="debugInfo">
        Debug-Modus aktiviert
    </div>

    <script>
        // Zammad Timetracking Popup Script
        class TimetrackingPopup {
            constructor() {
                console.log('Popup wird initialisiert...');
                
                this.isTracking = false;
                this.startTime = null;
                this.timerInterval = null;
                this.currentTicketId = null;
                
                this.initElements();
                this.initEventListeners();
                this.loadState();
            }
            
            initElements() {
                console.log('Initialisiere UI-Elemente...');
                
                this.statusDot = document.getElementById('statusDot');
                this.statusText = document.getElementById('statusText');
                this.ticketInfo = document.getElementById('ticketInfo');
                this.ticketId = document.getElementById('ticketId');
                this.timerDisplay = document.getElementById('timerDisplay');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.infoText = document.getElementById('infoText');
                this.notificationsToggle = document.getElementById('notificationsToggle');
                this.autoSubmitToggle = document.getElementById('autoSubmitToggle');
                this.debugInfo = document.getElementById('debugInfo');
                
                console.log('UI-Elemente initialisiert');
            }
            
            initEventListeners() {
                console.log('Richte Event Listener ein...');
                
                this.startBtn.addEventListener('click', () => {
                    console.log('Start-Button geklickt');
                    this.startTracking();
                });
                
                this.stopBtn.addEventListener('click', () => {
                    console.log('Stop-Button geklickt');
                    this.stopTracking();
                });
                
                this.notificationsToggle.addEventListener('change', () => {
                    console.log('Benachrichtigungen geändert:', this.notificationsToggle.checked);
                    this.saveSettings();
                });
                
                this.autoSubmitToggle.addEventListener('change', () => {
                    console.log('Auto-Submit geändert:', this.autoSubmitToggle.checked);
                    this.saveSettings();
                });
                
                // Debug-Modus Toggle
                document.querySelector('.header').addEventListener('dblclick', () => {
                    const isVisible = this.debugInfo.style.display !== 'none';
                    this.debugInfo.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible) {
                        this.debug('Debug-Modus aktiviert');
                    }
                });
                
                console.log('Event Listener eingerichtet');
            }
            
            debug(message) {
                const timestamp = new Date().toLocaleTimeString();
                console.log('[Popup Debug]', timestamp, message);
                this.debugInfo.textContent = timestamp + ': ' + message;
            }
            
            async loadState() {
                this.debug('Lade gespeicherten Status...');
                
                try {
                    const result = await chrome.storage.local.get(['zammadTrackingState', 'zammadSettings']);
                    const state = result.zammadTrackingState;
                    const settings = result.zammadSettings || {};
                    
                    this.debug('Status geladen: ' + JSON.stringify(state));
                    
                    // Settings anwenden
                    this.notificationsToggle.checked = settings.notifications !== false;
                    this.autoSubmitToggle.checked = settings.autoSubmit !== false;
                    
                    // Aktives Tracking wiederherstellen
                    if (state && state.isTracking && state.startTime) {
                        this.debug('Aktives Tracking gefunden');
                        
                        this.isTracking = true;
                        this.startTime = new Date(state.startTime);
                        this.currentTicketId = state.ticketId;
                        
                        this.updateUI();
                        this.startTimer();
                        
                        this.ticketId.textContent = '#' + state.ticketId;
                        this.ticketInfo.style.display = 'block';
                        this.infoText.textContent = 'Zeiterfassung läuft...';
                        this.infoText.className = 'info success';
                        
                        this.debug('Tracking wiederhergestellt für Ticket: ' + state.ticketId);
                    } else {
                        this.debug('Kein aktives Tracking - prüfe Seite');
                        await this.checkCurrentPage();
                    }
                    
                } catch (error) {
                    this.debug('Fehler beim Laden: ' + error.message);
                    console.error('Fehler beim Laden des Status:', error);
                    await this.checkCurrentPage();
                }
            }
            
            async checkCurrentPage() {
                this.debug('Prüfe aktuelle Seite...');
                
                try {
                    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                    this.debug('URL: ' + tab.url);
                    
                    if (this.isZammadUrl(tab.url)) {
                        this.debug('Zammad-Seite erkannt');
                        this.infoText.textContent = 'Bereit für Zeiterfassung';
                        this.infoText.className = 'info';
                        this.startBtn.disabled = false;
                    } else {
                        this.debug('Keine Zammad-Seite');
                        this.infoText.textContent = 'Öffnen Sie ein Zammad-Ticket';
                        this.infoText.className = 'info';
                        this.startBtn.disabled = true;
                    }
                } catch (error) {
                    this.debug('Fehler bei Seitenprüfung: ' + error.message);
                    this.infoText.textContent = 'Fehler beim Überprüfen der Seite';
                    this.infoText.className = 'info error';
                }
            }
            
            isZammadUrl(url) {
                if (!url) return false;
                
                const patterns = [
                    /zammad/i,
                    /ticket/i,
                    /agent/i,
                    /\/tickets?\//,
                    /ticketZoom/i
                ];
                
                return patterns.some(pattern => pattern.test(url));
            }
            
            async startTracking() {
                try {
                    this.debug('Starte Zeiterfassung...');
                    
                    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                    this.debug('Tab URL: ' + tab.url);
                    
                    if (!this.isZammadUrl(tab.url)) {
                        this.infoText.textContent = 'Bitte öffnen Sie ein Zammad-Ticket.';
                        this.infoText.className = 'info error';
                        this.debug('Keine Zammad-URL');
                        return;
                    }
                    
                    this.startBtn.disabled = true;
                    this.infoText.textContent = 'Starte Zeiterfassung...';
                    this.infoText.className = 'info';
                    
                    // Content Script injizieren
                    this.debug('Injiziere Content Script...');
                    try {
                        await chrome.scripting.executeScript({
                            target: { tabId: tab.id },
                            files: ['content.js']
                        });
                        this.debug('Content Script injiziert');
                    } catch (e) {
                        this.debug('Content Script Fehler: ' + e.message);
                    }
                    
                    // Warten für Content Script
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Ticket-ID versuchen zu finden
                    let ticketId = await this.getTicketId(tab);
                    
                    if (!ticketId) {
                        this.debug('Keine Ticket-ID - verwende Fallback');
                        ticketId = 'fallback-' + Date.now();
                    }
                    
                    // Tracking starten
                    this.debug('Starte Timer für Ticket: ' + ticketId);
                    this.isTracking = true;
                    this.startTime = new Date();
                    this.currentTicketId = ticketId;
                    
                    // Status speichern
                    await chrome.storage.local.set({
                        zammadTrackingState: {
                            isTracking: true,
                            startTime: this.startTime.toISOString(),
                            ticketId: ticketId,
                            url: tab.url
                        }
                    });
                    
                    // UI aktualisieren
                    this.updateUI();
                    this.startTimer();
                    
                    this.ticketId.textContent = '#' + ticketId;
                    this.ticketInfo.style.display = 'block';
                    this.infoText.textContent = 'Zeiterfassung gestartet!';
                    this.infoText.className = 'info success';
                    
                    // Background Script benachrichtigen
                    try {
                        chrome.runtime.sendMessage({
                            action: 'trackingStarted',
                            data: { ticketId: ticketId, startTime: this.startTime.toISOString() }
                        });
                        this.debug('Background Script benachrichtigt');
                    } catch (error) {
                        this.debug('Background Script Fehler: ' + error.message);
                    }
                    
                    this.debug('Zeiterfassung erfolgreich gestartet');
                    
                    // Popup schließen
                    setTimeout(() => window.close(), 2000);
                    
                } catch (error) {
                    this.debug('Kritischer Fehler: ' + error.message);
                    console.error('Startfehler:', error);
                    this.infoText.textContent = 'Fehler: ' + error.message;
                    this.infoText.className = 'info error';
                    this.startBtn.disabled = false;
                }
            }
            
            async getTicketId(tab) {
                // Mehrere Strategien versuchen
                
                // 1. Content Script fragen
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        this.debug('Content Script Versuch ' + attempt);
                        const response = await chrome.tabs.sendMessage(tab.id, { action: 'getTicketId' });
                        if (response && response.ticketId) {
                            this.debug('Ticket-ID von Content Script: ' + response.ticketId);
                            return response.ticketId;
                        }
                    } catch (error) {
                        this.debug('Content Script Versuch ' + attempt + ' fehlgeschlagen');
                        if (attempt < 3) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                // 2. URL-Pattern versuchen
                this.debug('Versuche URL-Parsing...');
                const urlPatterns = [
                    /\/ticket\/zoom\/(\d+)/,
                    /\/ticket.*?\/(\d+)/,
                    /ticket.*?(\d+)/,
                    /#.*?(\d+)/
                ];
                
                for (const pattern of urlPatterns) {
                    const match = tab.url.match(pattern);
                    if (match && match[1]) {
                        this.debug('Ticket-ID aus URL: ' + match[1]);
                        return match[1];
                    }
                }
                
                this.debug('Keine Ticket-ID gefunden');
                return null;
            }
            
            async stopTracking() {
                try {
                    this.debug('Stoppe Zeiterfassung...');
                    
                    if (!this.isTracking || !this.startTime) {
                        this.debug('Keine aktive Zeiterfassung');
                        this.infoText.textContent = 'Keine aktive Zeiterfassung';
                        this.infoText.className = 'info error';
                        return;
                    }
                    
                    // Zeit berechnen
                    const endTime = new Date();
                    const duration = Math.round((endTime - this.startTime) / 1000);
                    const durationMinutes = Math.round(duration / 60);
                    const durationText = this.formatDuration(duration);
                    
                    this.debug('Dauer: ' + durationText + ' (' + durationMinutes + ' Min)');
                    
                    // Status zurücksetzen
                    this.isTracking = false;
                    const ticketId = this.currentTicketId;
                    this.currentTicketId = null;
                    
                    // UI aktualisieren
                    this.updateUI();
                    this.stopTimer();
                    
                    // Storage löschen
                    await chrome.storage.local.remove(['zammadTrackingState']);
                    this.debug('Status gelöscht');
                    
                    // Auto-Submit versuchen
                    let autoSubmitSuccess = await this.tryAutoSubmit(ticketId, durationMinutes);
                    
                    // UI Feedback
                    this.ticketInfo.style.display = 'none';
                    if (autoSubmitSuccess) {
                        this.infoText.textContent = 'Zeit eingetragen: ' + durationMinutes + ' Min';
                        this.infoText.className = 'info success';
                    } else {
                        this.infoText.textContent = 'Bitte ' + durationMinutes + ' Min manuell eintragen';
                        this.infoText.className = 'info error';
                    }
                    
                    // Background Script benachrichtigen
                    try {
                        chrome.runtime.sendMessage({
                            action: 'trackingStopped',
                            data: { 
                                ticketId: ticketId, 
                                duration: durationText,
                                success: autoSubmitSuccess
                            }
                        });
                    } catch (error) {
                        this.debug('Background Script Fehler: ' + error.message);
                    }
                    
                    this.debug('Zeiterfassung erfolgreich beendet');
                    
                    // Popup schließen
                    setTimeout(() => window.close(), 3000);
                    
                } catch (error) {
                    this.debug('Stopp-Fehler: ' + error.message);
                    console.error('Stopp-Fehler:', error);
                    this.infoText.textContent = 'Fehler beim Stoppen: ' + error.message;
                    this.infoText.className = 'info error';
                }
            }
            
            async tryAutoSubmit(ticketId, durationMinutes) {
                try {
                    this.debug('Versuche automatisches Eintragen...');
                    
                    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                    
                    const response = await chrome.tabs.sendMessage(tab.id, { 
                        action: 'submitTime',
                        duration: durationMinutes,
                        ticketId: ticketId
                    });
                    
                    if (response && response.success) {
                        this.debug('Auto-Submit erfolgreich');
                        return true;
                    } else {
                        this.debug('Auto-Submit fehlgeschlagen');
                        return false;
                    }
                } catch (error) {
                    this.debug('Auto-Submit Fehler: ' + error.message);
                    return false;
                }
            }
            
            updateUI() {
                if (this.isTracking) {
                    this.statusDot.className = 'status-dot active';
                    this.statusText.textContent = 'Aktiv';
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                } else {
                    this.statusDot.className = 'status-dot inactive';
                    this.statusText.textContent = 'Nicht aktiv';
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.timerDisplay.textContent = '00:00:00';
                }
            }
            
            startTimer() {
                this.debug('Timer gestartet');
                this.timerInterval = setInterval(() => {
                    if (this.startTime) {
                        const elapsed = Math.round((new Date() - this.startTime) / 1000);
                        this.timerDisplay.textContent = this.formatDuration(elapsed);
                    }
                }, 1000);
            }
            
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                    this.debug('Timer gestoppt');
                }
            }
            
            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                return hours.toString().padStart(2, '0') + ':' + 
                       minutes.toString().padStart(2, '0') + ':' + 
                       secs.toString().padStart(2, '0');
            }
            
            async saveSettings() {
                const settings = {
                    notifications: this.notificationsToggle.checked,
                    autoSubmit: this.autoSubmitToggle.checked
                };
                
                await chrome.storage.local.set({ zammadSettings: settings });
                this.debug('Einstellungen gespeichert');
            }
        }
        
        // Popup beim Laden initialisieren
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM geladen - initialisiere Popup');
            new TimetrackingPopup();
        });
        
        console.log('Popup Script geladen');
    </script>
</body>
</html>